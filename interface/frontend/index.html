<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Adobe 1B Reader • Upload & Analyze</title>
  <link rel="stylesheet" href="/app/styles.css" />
</head>
<body>
  <!-- Hero Section -->
   <div class="hero-section">
  <div class="hero">
    <div class="hero-content">
      <img src="assets/Adobe_Acrobat_DC_logo_2020.svg" alt="Adobe Acrobat Logo" class="adobe-icon" />
      <h1 class="hero-title">Experience Adobe Acrobat.Ai</h1>
      <p class="hero-desc">
        Upload, analyze, and get insights from the PDFs you read instantly.
      </p>
      <button class="cta-btn" onclick="document.getElementById('main-card').scrollIntoView({behavior:'smooth'})">
        Get Started
      </button>
    </div>
  </div>
  </div>

  <!-- Upload & Analyze Section -->
  <div class="container" id="main-card">
    <div class="card">
      <div style="font-size:1.15rem;font-weight:600;margin-bottom:10px;">Upload & Analyze — Adobe Acrobat</div>
      <div class="muted" style="margin-bottom:18px;">
        Drop PDFs here or choose files. Then pick a PDF, add persona/job (optional), and analyze.
      </div>
<div class="row">
  <label for="file-input" class="file-btn">Choose Files</label>
  <input type="file" id="file-input" multiple accept="application/pdf" />
  <button id="upload">Upload</button>
  <button id="refresh">Clear All Files</button>
</div>
      <div id="docs" class="docs"></div>
    </div>

    <div class="card">
      <div class="col">
        <div class="row">
  <label class="label-fixed">Select PDF</label>
  <select id="doc-select" class="flex-1"></select>
</div>
</div>
</div>
<div class="card">
  
  <div class="col">
          <div style="font-size:1.15rem;font-weight:600;margin-bottom:10px;">Add-On (optional)</div>

        <div class="row">
          <label class="label-fixed">Persona</label>
          <input type="text" id="persona" class="flex-1" placeholder="e.g., Travel Planner, Food Critic, HR Professional" />
        </div>
        <div class="row">
          <label class="label-fixed">Job to be done</label>
          <input type="text" id="job" class="flex-1" placeholder="e.g., Plan a trip for college friends, Create employee onboarding forms" />
        </div>
        <div class="row justify-end">
          <button id="analyze">Analyze →</button>
        </div>
        <div class="muted" id="status"></div>
      </div>
    </div>
  
  </div>

  <!-- Overlay -->
  <div id="overlay" class="overlay">
    <div class="center">
      <div class="spinner"></div>
      <div id="overlay-text">Analyzing…</div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    Made By Commit This Later. Adobe India Hackathon 2025.
  </div>
</body>
  <script>
    let adobeApiKey = '';
    
    // Fetch configuration including Adobe API key
    async function loadConfig() {
      try {
        const config = await api('/api/config');
        adobeApiKey = config.adobe_api_key;
        if (adobeApiKey && adobeApiKey !== 'YOUR_ADOBE_EMBED_CLIENT_ID_HERE') {
          localStorage.setItem('adobe_embed_client_id', adobeApiKey);
          const tipElement = document.querySelector('.muted');
          if (tipElement) {
            tipElement.textContent = 'Adobe API key loaded from server configuration';
            tipElement.style.color = '#C0C0C0';
            //tipElement.style.size = '0.5rem';
          }
        } else {
          const tipElement = document.querySelector('.muted');
          if (tipElement) {
            tipElement.textContent = 'Warning: Adobe API key not configured. Set ADOBE_API in .env file.';
            tipElement.style.color = '#f44336';
          }
        }
      } catch (e) {
        console.error('Failed to load config:', e);
        const tipElement = document.querySelector('.muted');
        if (tipElement) {
          tipElement.textContent = 'Error: Cannot load configuration from server';
          tipElement.style.color = '#f44336';
        }
      }
    }

    const api = async (path, opts={}) => {
      const baseUrl = window.location.origin;
      const fullUrl = path.startsWith('/') ? baseUrl + path : baseUrl + '/' + path;
      const r = await fetch(fullUrl, opts);
      if (!r.ok) {
        const text = await r.text().catch(() => '');
        throw new Error(`HTTP ${r.status}: ${text}`);
      }
      return r.json();
    };
    const docSelect = document.getElementById('doc-select');
    const docsEl = document.getElementById('docs');
    const overlay = document.getElementById('overlay');
    const overlayText = document.getElementById('overlay-text');
    const statusEl = document.getElementById('status');

    // --- updated refreshDocs ---
    async function refreshDocs() {
      try {
        const data = await api('/api/documents');
        docSelect.innerHTML = '';
        docsEl.innerHTML = '';

        (data.documents || []).forEach((d, idx) => {
          // Add option to <select>
          const o = document.createElement('option');
          o.value = d.name; 
          o.textContent = d.name; 
          docSelect.appendChild(o);

          // Add clickable card
          const card = document.createElement('div'); 
          card.className = 'doc'; 
          card.textContent = d.name;

          // click → update select
          card.addEventListener('click', () => {
            docSelect.value = d.name;
            highlightActiveDoc(d.name);
          });

          docsEl.appendChild(card);

          // Select the first by default
          if (idx === 0) {
            docSelect.value = d.name;
            highlightActiveDoc(d.name);
          }
        });

      } catch (e) {
        console.error('refreshDocs error', e);
        statusEl.textContent = 'Cannot reach API. Is the FastAPI server running on port 8000?';
      }
    }

    // highlight helper
    function highlightActiveDoc(name) {
      document.querySelectorAll('.doc').forEach(el => {
        el.classList.toggle('active', el.textContent === name);
      });
    }

    // sync dropdown → docs
    docSelect.addEventListener('change', () => {
      highlightActiveDoc(docSelect.value);
    });

    async function clearAllDocs() {
      if (!confirm('Are you sure you want to delete all uploaded files?')) return;
      try {
        overlay.style.display = 'flex'; overlayText.textContent = 'Clearing files…';
        await api('/api/documents', { method: 'DELETE' });
        await refreshDocs();
        overlay.style.display = 'none';
        statusEl.textContent = 'All files cleared successfully';
        setTimeout(() => statusEl.textContent = '', 3000);
      } catch (e) {
        overlay.style.display = 'none';
        console.error('clearAllDocs error', e);
        statusEl.textContent = 'Failed to clear files. See console.';
      }
    }

    document.getElementById('refresh').onclick = clearAllDocs;
    
    loadConfig().then(() => refreshDocs());

    document.getElementById('upload').onclick = async () => {
      const files = document.getElementById('file-input').files;
      if (!files.length) return;
      const fd = new FormData();
      for (const f of files) fd.append('files', f);
      overlay.style.display = 'flex'; overlayText.textContent = 'Uploading…';
      await api('/api/upload', { method: 'POST', body: fd });
      overlay.style.display = 'none';
      await refreshDocs();
    };

    document.getElementById('analyze').onclick = async () => {
      if (!docSelect.value) { 
        alert('Select a PDF first.'); 
        return; 
      }
      const personaInput = document.getElementById('persona');
      const jobInput = document.getElementById('job');

      const persona = personaInput ? personaInput.value.trim() : '';
      const job = jobInput ? jobInput.value.trim() : '';

      sessionStorage.setItem('persona', persona || '');
      sessionStorage.setItem('job', job || '');

      const fd = new FormData();
      fd.append('filename', docSelect.value);
      fd.append('persona', persona);
      fd.append('job_to_be_done', job);

      overlay.style.display = 'flex';
      overlayText.textContent = 'Analyzing…';

      try {
        const res = await api('/api/analyze', { method: 'POST', body: fd });
        sessionStorage.setItem('analysis_result', JSON.stringify(res));
        sessionStorage.setItem('persona', persona);
        sessionStorage.setItem('job', job);
        window.location.href = '/app/viewer.html';
      } catch (e) {
        overlay.style.display = 'none';
        statusEl.textContent = 'Failed to analyze. See console.';
        console.error(e);
      }
    };
</script>

</body>
</html>